name: Python tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Test on Python 3.6 (lowest supported, requires container)
  py36:
    name: Test on Python 3.6
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    container:
      image: python:3.6-slim
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies & test
        run: |
          pip install -r requirements.txt
          pip install -r requirements.dev.txt
          pip install -e .
          flake8 scripts/ src/redoctor/ --count --select=E9,F63,F7,F82,F821 --show-source --statistics
          python scripts/check_py36_compat.py src/redoctor/*.py
          pytest -v -n auto --timeout=60 tests/

  # Test on Python 3.10 (middle) and 3.13 (latest)
  modern:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    strategy:
      matrix:
        python-version: ['3.10', '3.13']
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements.dev.txt
        pip install -e .
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - name: Test with pytest
      run: |
        pytest -v -n auto --timeout=60 tests/
